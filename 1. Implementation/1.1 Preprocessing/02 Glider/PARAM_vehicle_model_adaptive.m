function [par_TIR,par_VEH] = PARAM_vehicle_model_adaptive(par_MDT, IP, Segment, m, NR, par_VEH, par_TIR)
% Adaption of the suspension and glider-Parameters to fit the
% chosen powertrain layout and to ensure a comparable driving behaviour in
% the dynamic vehicle behaviour. 

% Source:
% C. Angerer, B. Mößner, M. Lüst, A. Holtz, F. Sträußl, und M. Lienkamp, 
% “Parameter-Adaption for a Vehicle Dynamics Model for the Evaluation 
% of Powertrain Concept Designs,” in International Conference on 
% New Energy Vehicle and Vehicle Engineering (NEVVE), Seoul, Korea, 2018.


%% others
par_VEH.g  = 9.81;      %acceleration of gravity

%% Functional parameters
par_VEH.sw_kinematics = 1;     %switch for kinematics (0,,,off 1,,,on)
par_VEH.sw_compliance = 0;     %switch for ealstokinematics (0,,,off 1,,,on)
par_VEH.sw_rbm = 0;     %Schalter Restbremsmoment (0...aus 1...an)
par_VEH.sw_awr = 0;     %Schalter Antriebswellenreibung (0...aus 1...an)
par_VEH.sw_rlr = 0;     %Schalter Radlagerreibung (0...aus 1...an)
par_VEH.sw_lku = 0;     %Schalter Lenkkraftunterstützung (0...aus 1...an)
par_VEH.sw_chassis_losses = 0;  %Schalter Berechnung Fahrwerksverluste  (0...aus 1...an)
par_VEH.sw_powertrain_losses = 1; %Schalter Berechnung Antriebsstrangverluste  (0...aus 1...an)
par_VEH.FWD = 1;               %switch for FWD (0...off 1...on)
par_VEH.RWD = 1;               %switch for RWD (0...off 1...on)
par_VEH.bkv = 0.5;           %percentage brake torque front axis
par_VEH.MixedTires = 0;      %Schalter Auslegung Mischbereifung

%%%Berechnungen
par_VEH.sw_rbm = par_VEH.sw_rbm*par_VEH.sw_chassis_losses;
par_VEH.sw_awr = par_VEH.sw_awr*par_VEH.sw_chassis_losses;
par_VEH.sw_rlr = par_VEH.sw_rlr*par_VEH.sw_chassis_losses;
par_VEH.sw_lku = par_VEH.sw_lku*par_VEH.sw_chassis_losses;

%% PID parametres
P=20;
I=2600;

%% Kinematic and compliance
%Kinematics          
%(Input: wheel hub in m;  Output: wheel alignment in degree)
%Toe-in positive, negative camber is negative, positive compression
% Parameter analog zu polyval-Befehl
% Lenkwinkelabhängigkeit Spur/Sturzwinkel
% Berechnung:
% toe/camber*(1+(delta_Fahrer*p1+delta_Fahrer^2*p2))+p3*delta_Fahrer+p4*delta_Fahrer^2
par_VEH.kin_lw_toe_f = [0 0 0 0];       %Spurwinkeländerung über Lenkwinkel VA
par_VEH.kin_lw_camber_f = [0 0 0 0];    %Sturzwinkeländerung über Lenkwinkel VA

%Elastokinematic    (Input: Force in N;   Output: wheel orientation change in degree)
%Sturz: Kraft nach innen positiv ( 
% Parameter analog zu polyvar-Befehl
par_VEH.elkin_x_camb_f      =[0  0]*1;
par_VEH.elkin_x_toe_f       =[-7.75588967267731e-25 -2.47682578802638e-20 6.67398468074408e-17 2.10571854334811e-12 -1.49103797899336e-09 -3.91850776120119e-05 -0.00820811682059795];
par_VEH.elkin_y_camb_f      =[0.000122944512727273 0.00279337333333334]*1;
par_VEH.elkin_y_toe_f       =[-1.27331314452138e-09 -0.000114354625454545 0.00409301949656755]*1;
par_VEH.elkin_x_camb_r      =[0      0]*1;
par_VEH.elkin_x_toe_r       =[-5.20336116972270e-11 1.80405727272727e-05 0.00208898389016018];
par_VEH.elkin_y_camb_r      =[0.000163486836363636 -0.00283220000000001]*1;
par_VEH.elkin_y_toe_r       =[3.00617046568993e-10 4.17691000000000e-05 0.00147319372997710]*1;
par_VEH.elkin_camb_twistbeam=[0    0];
par_VEH.elkin_toe_twistbeam =[0    0];

%% Mass data

%%% Centre of mass position
%(Construction origin center of the front axle, x backward, y to the right)
par_VEH = Reifen(par_VEH, m, IP, Segment);  %wheel-radius and inertia
par_VEH = SP_x(par_VEH, m, IP, NR);         %CoM position in x-direction [m]

%Variation der Schwerpunktposition in x-Richtung
%par_VEH.xSP = (0.4 + 0.05*evalin('base', 'y'))*IP.Radstand/1000;
par_VEH.ySP = 0.0;                          %CoM position in y-direction [m]
par_VEH = SP_z(par_VEH, m, IP, NR);         %CoM position in z-direction [m]
par_VEH.ztSPf = 0; %%to change              %CoM position of the unsprung masses front in z-direction [m]
par_VEH.ztSPr = 0; %%to change              %CoM position of the unsprung masses rear in z-direction [m]

%%% Traegheiten
par_VEH = I_x(par_VEH, m, IP, NR, par_MDT);         %Inertia about x_axis [kg/m^2]
par_VEH = I_y(par_VEH, m, IP, NR, par_MDT);         %Inertia about y_axis [kg/m^2]
par_VEH = I_z(par_VEH, m, IP, NR, par_MDT);         %Inertia about z_axis [kg/m^2]
par_VEH.Iwf = par_VEH.IRad_f;        %Inertia of the front wheel if necessary including powertrain [kg/m^2] %Powertrain to be added
par_VEH.Iwr = par_VEH.IRad_r;        %Inertia of the rear wheel if necessary including powertrain [kg/m^2] %Powertrain to be added

%% Undercarriage data
par_VEH.l =     IP.Radstand/1000;      %wheelbase [m]
par_VEH.sF =    IP.SpW_v/1000;         %front track [m]
par_VEH.sR =    IP.SpW_h/1000;         %rear track [m]
par_VEH.lF = par_VEH.xSP; 
par_VEH.lR = par_VEH.l-par_VEH.xSP; 

par_VEH.ssF = par_VEH.sF;    %Front track between springs [m]
par_VEH.ssR = par_VEH.sR;    %Rear track between springs [m]

% Variablen Federrate über den Radhub
% Federkennlinie VA: [Radhub in m, Federkraft in N]
%par_VEH.cF_front = [-0.0600000000000000 591.021200000000;-0.0590000000000000 693.972500000000;-0.0580000000000000 797.275800000000;-0.0570000000000000 839.172400000000;-0.0560000000000000 848.547900000000;-0.0550000000000000 857.916800000000;-0.0540000000000000 867.280200000000;-0.0530000000000000 876.639100000000;-0.0520000000000000 885.994400000000;-0.0510000000000000 895.347100000000;-0.0500000000000000 904.698300000000;-0.0490000000000000 914.048700000000;-0.0480000000000000 923.399400000000;-0.0470000000000000 932.751300000000;-0.0460000000000000 942.105300000000;-0.0450000000000000 951.462300000000;-0.0440000000000000 960.823200000000;-0.0430000000000000 970.188400000000;-0.0420000000000000 979.558700000000;-0.0410000000000000 988.935100000000;-0.0400000000000000 998.318500000000;-0.0390000000000000 1007.71000000000;-0.0380000000000000 1017.10900000000;-0.0370000000000000 1026.51900000000;-0.0360000000000000 1035.93800000000;-0.0350000000000000 1045.36900000000;-0.0340000000000000 1054.81200000000;-0.0330000000000000 1064.26800000000;-0.0320000000000000 1073.73700000000;-0.0310000000000000 1083.22100000000;-0.0300000000000000 1092.72100000000;-0.0290000000000000 1102.23600000000;-0.0280000000000000 1111.76900000000;-0.0270000000000000 1121.32000000000;-0.0260000000000000 1130.88900000000;-0.0250000000000000 1140.47800000000;-0.0240000000000000 1150.08700000000;-0.0230000000000000 1159.71700000000;-0.0220000000000000 1169.36900000000;-0.0210000000000000 1179.04400000000;-0.0200000000000000 1188.74200000000;-0.0190000000000000 1198.46500000000;-0.0180000000000000 1208.21300000000;-0.0170000000000000 1217.98700000000;-0.0160000000000000 1227.78800000000;-0.0150000000000000 1237.61700000000;-0.0140000000000000 1247.47400000000;-0.0130000000000000 1257.36000000000;-0.0120000000000000 1267.28000000000;-0.0110000000000000 1277.23500000000;-0.0100000000000000 1287.22500000000;-0.00900000000000000 1297.25100000000;-0.00800000000000000 1307.31200000000;-0.00700000000000000 1317.41100000000;-0.00600000000000000 1327.54700000000;-0.00500000000000000 1337.72100000000;-0.00400000000000000 1347.93400000000;-0.00300000000000000 1358.18700000000;-0.00200000000000000 1368.47900000000;-0.00100000000000000 1378.81200000000;-3.82900100000000e-18 1389.18700000000;0.00100000000000000 1399.60400000000;0.00200000000000000 1410.06400000000;0.00300000000000000 1420.56800000000;0.00400000000000000 1431.11700000000;0.00500000000000000 1441.71100000000;0.00600000000000000 1452.35100000000;0.00700000000000000 1463.03900000000;0.00800000000000000 1473.77400000000;0.00900000000000000 1484.55800000000;0.0100000000000000 1495.39200000000;0.0110000000000000 1506.27700000000;0.0120000000000000 1517.21300000000;0.0130000000000000 1528.20100000000;0.0140000000000000 1539.24300000000;0.0150000000000000 1550.33900000000;0.0160000000000000 1561.49000000000;0.0170000000000000 1585.47000000000;0.0180000000000000 1617.54500000000;0.0190000000000000 1649.60500000000;0.0200000000000000 1681.45800000000;0.0210000000000000 1712.76800000000;0.0220000000000000 1743.19600000000;0.0230000000000000 1772.60700000000;0.0240000000000000 1802.05600000000;0.0250000000000000 1831.73300000000;0.0260000000000000 1861.63300000000;0.0270000000000000 1891.75200000000;0.0280000000000000 1922.08900000000;0.0290000000000000 1952.64100000000;0.0300000000000000 1983.40600000000;0.0310000000000000 2014.40300000000;0.0320000000000000 2045.67000000000;0.0330000000000000 2077.20300000000;0.0340000000000000 2108.99700000000;0.0350000000000000 2143.06200000000;0.0360000000000000 2180.93900000000;0.0370000000000000 2221.51900000000;0.0380000000000000 2263.71300000000;0.0390000000000000 2306.41800000000;0.0400000000000000 2348.63600000000;0.0410000000000000 2391.82900000000;0.0420000000000000 2436.47200000000;0.0430000000000000 2482.25900000000;0.0440000000000000 2528.88200000000;0.0450000000000000 2576.03200000000;0.0460000000000000 2625.97100000000;0.0470000000000000 2684.79400000000;0.0480000000000000 2750.59800000000;0.0490000000000000 2821.12700000000;0.0500000000000000 2894.16900000000;0.0510000000000000 2967.48300000000;0.0520000000000000 3053.86300000000;0.0530000000000000 3163.06600000000;0.0540000000000000 3292.14100000000;0.0550000000000000 3439.14300000000;0.0560000000000000 3603.00100000000;0.0570000000000000 3782.29600000000;0.0580000000000000 3999.22200000000;0.0590000000000000 4268.71000000000;0.0600000000000000 4582.57500000000];
%par_VEH.cF_rear = [-0.0600000000000000 844.744800000000;-0.0590000000000000 942.577300000000;-0.0580000000000000 992.110400000000;-0.0570000000000000 1005.06600000000;-0.0560000000000000 1018.04000000000;-0.0550000000000000 1031.03400000000;-0.0540000000000000 1044.04900000000;-0.0530000000000000 1057.08300000000;-0.0520000000000000 1070.13800000000;-0.0510000000000000 1083.21300000000;-0.0500000000000000 1096.31100000000;-0.0490000000000000 1109.43300000000;-0.0480000000000000 1122.58000000000;-0.0470000000000000 1135.75400000000;-0.0460000000000000 1148.95400000000;-0.0450000000000000 1162.18400000000;-0.0440000000000000 1175.44300000000;-0.0430000000000000 1188.73400000000;-0.0420000000000000 1202.05700000000;-0.0410000000000000 1215.41400000000;-0.0400000000000000 1228.80600000000;-0.0390000000000000 1242.23400000000;-0.0380000000000000 1255.70000000000;-0.0370000000000000 1269.20500000000;-0.0360000000000000 1282.76600000000;-0.0350000000000000 1296.38800000000;-0.0340000000000000 1310.06800000000;-0.0330000000000000 1323.80500000000;-0.0320000000000000 1337.59700000000;-0.0310000000000000 1351.44400000000;-0.0300000000000000 1365.34500000000;-0.0290000000000000 1379.29900000000;-0.0280000000000000 1393.30700000000;-0.0270000000000000 1407.36800000000;-0.0260000000000000 1421.48300000000;-0.0250000000000000 1435.65100000000;-0.0240000000000000 1449.87300000000;-0.0230000000000000 1464.14900000000;-0.0220000000000000 1478.47900000000;-0.0210000000000000 1492.86400000000;-0.0200000000000000 1507.30300000000;-0.0190000000000000 1521.79800000000;-0.0180000000000000 1536.34900000000;-0.0170000000000000 1550.95600000000;-0.0160000000000000 1565.62000000000;-0.0150000000000000 1580.35500000000;-0.0140000000000000 1595.16200000000;-0.0130000000000000 1610.04200000000;-0.0120000000000000 1624.99300000000;-0.0110000000000000 1640.01500000000;-0.0100000000000000 1655.10900000000;-0.00900000000000000 1670.27500000000;-0.00800000000000000 1685.51300000000;-0.00700000000000000 1700.82300000000;-0.00600000000000000 1716.20600000000;-0.00500000000000000 1731.66300000000;-0.00400000000000000 1747.19300000000;-0.00300000000000000 1762.79800000000;-0.00200000000000000 1778.47800000000;-0.00100000000000000 1794.23400000000;-3.82900100000000e-18 1810.06700000000;0.00100000000000000 1825.97700000000;0.00200000000000000 1841.96600000000;0.00300000000000000 1858.03400000000;0.00400000000000000 1874.18200000000;0.00500000000000000 1890.41100000000;0.00600000000000000 1906.72200000000;0.00700000000000000 1923.11500000000;0.00800000000000000 1939.59300000000;0.00900000000000000 1956.15500000000;0.0100000000000000 1972.80400000000;0.0110000000000000 1989.53900000000;0.0120000000000000 2006.36200000000;0.0130000000000000 2023.27700000000;0.0140000000000000 2040.28900000000;0.0150000000000000 2057.39800000000;0.0160000000000000 2074.60400000000;0.0170000000000000 2091.91000000000;0.0180000000000000 2109.31500000000;0.0190000000000000 2145.39100000000;0.0200000000000000 2184.17600000000;0.0210000000000000 2222.80800000000;0.0220000000000000 2260.99600000000;0.0230000000000000 2298.43500000000;0.0240000000000000 2334.80700000000;0.0250000000000000 2370.51100000000;0.0260000000000000 2406.46200000000;0.0270000000000000 2442.66600000000;0.0280000000000000 2479.12400000000;0.0290000000000000 2515.83600000000;0.0300000000000000 2552.80300000000;0.0310000000000000 2590.03000000000;0.0320000000000000 2627.54700000000;0.0330000000000000 2665.35400000000;0.0340000000000000 2703.45000000000;0.0350000000000000 2741.83600000000;0.0360000000000000 2780.93700000000;0.0370000000000000 2823.73100000000;0.0380000000000000 2869.86800000000;0.0390000000000000 2918.23700000000;0.0400000000000000 2967.72600000000;0.0410000000000000 3017.19800000000;0.0420000000000000 3066.58400000000;0.0430000000000000 3117.54600000000;0.0440000000000000 3169.85200000000;0.0450000000000000 3223.19600000000;0.0460000000000000 3277.26000000000;0.0470000000000000 3331.97200000000;0.0480000000000000 3393.76500000000;0.0490000000000000 3463.75700000000;0.0500000000000000 3539.60800000000;0.0510000000000000 3619.04300000000;0.0520000000000000 3699.77700000000;0.0530000000000000 3784.61500000000;0.0540000000000000 3892.12100000000;0.0550000000000000 4021.56700000000;0.0560000000000000 4170.49700000000;0.0570000000000000 4336.87800000000;0.0580000000000000 4519.27900000000;0.0590000000000000 4728.71500000000;0.0600000000000000 4996.18800000000];
[par_VEH] = spring_damper(par_VEH);
%siehe constant_springrate

par_VEH.sdF = 1*par_VEH.sF;    %Front track between dampers [m]
par_VEH.sdR = 1*par_VEH.sR;   %Rear track between dampers [m]
par_VEH.ddF= 0;   %damping rate front
par_VEH.ddR= 0;   %damping rate rear 

%Default-Werte aus Model-SUV
%par_VEH.ddF_comp= [-4288 0];   %Dämpferrate vorn rebound in Ns/m
%par_VEH.ddF_reb = [-9481 0];   %Dämpferrate vorn compression in Ns/m
%par_VEH.ddR_comp= [-2506 0];     %Dämpferrate hinten compression in Ns/m
%par_VEH.ddR_reb=  [-4187 0];     %Dämpferrate hinten rebound in Ns/m

%par_VEH.slopeRA =   0.00;%-500/2421;      %%not found                              %slope roll axis
%par_VEH.heightRC=   (0.113)-par_VEH.r_stat0;      %%not found                      %height roll center
%Wankzentrenhoehen BEV 2018
par_VEH.zRCf    =   (0.09)-par_VEH.r_stat0;      %roll center height front
par_VEH.zRCr    =   (0.09)-par_VEH.r_stat0;           %roll center height rear

par_VEH.sarbF = par_VEH.sF;  %Stabilizer Track front [m]
par_VEH.sarbR = par_VEH.sR;  %Stabilizer Track rear [m]
par_VEH = Stabi(par_VEH, par_TIR, IP);

% Mischbereifung auslegen
if par_VEH.MixedTires == 1 && par_VEH.EG_opt.trigger == 1
    [par_TIR,par_VEH] = Mischbereifung(par_TIR,par_VEH);
else
end

% Adaptive Parametrierung Kinematik
par_VEH = Sturzgradient(par_VEH);
par_VEH.kin_camb_f = [par_VEH.wsg_F -0.5];
par_VEH.kin_camb_r = [par_VEH.wsg_R -1];
par_VEH = Spurgradient(par_VEH,par_TIR,IP);
par_VEH.kin_toe_f = [par_VEH.wlg 0];
par_VEH.kin_toe_r =	[-par_VEH.wlg 0];

%Default-Werte aus Model-SUV
% par_VEH.carbF = 48072.67;  %(resulting) Spring rate front anti-roll bar [N/m]
% par_VEH.carbR = 12832.34;      %(resulting) Spring rate rear anti-roll bar [N/m]


par_VEH.zPC =       0.2-par_VEH.r_stat0;       %approximated                       %Height of pitch center [m]
par_VEH.isteerL=    [ 1.4726e-05    0.0646	0]; %N.F.
par_VEH.isteerR=    [-1.4726e-05	0.0646	0]; %N.F.
par_VEH.isteer=     par_VEH.isteerR;
par_VEH.isteer_skalar= 1/polyval(par_VEH.isteer,1);
%% Aerodynamic data
%Pressure point position
par_VEH.xDP = par_VEH.xSP;  %Pressure point position in x-direction [m]
par_VEH.yDP = 0.000;        %Pressure point position in y-direction [m]
% par_VEH.zDP = 0.65756;      %Pressure point position in z-direction [m]
par_VEH.lDP = -par_VEH.xDP+par_VEH.xSP; %Distance pressure point to CoM in x-direction SP-KOS
par_VEH.sDP = -par_VEH.yDP+par_VEH.ySP; %Distance pressure point to CoM in y-direction SP-KOS
%Druckbeiwerte
par_VEH.cx = IP.cw;     %cx=cw [-]
par_VEH.cy = 0;   %cy [-]	
par_VEH.czfront = -0.09315;   %cz front axis*A [-]
par_VEH.czrear = -0.09315;    %cz rear axis*A [-]
%sonstiges
par_VEH.rhoair = 1.2041; %air density [kg/m^3]
par_VEH.Afront = IP.A;    %Frontal area [m^2]
par_VEH.cz = 0;


%Other 
%par_VEH.dt.other.eta_Kegel = par_MDT.other.eta_Kegel;
par_VEH.dt.other.wkg_last = Lastkennfeld_WKG();     %Blanko-Verlauf des lastabhängigen WKG
par_VEH.dt.other.wkg_last_bp = 0:1000;              %Breakpoints Lastkennfelder
par_VEH.dt.other.PT_Num =   [0  0.0488];            %Numerator PT1 Antriebsstrang
par_VEH.dt.other.PT_Denom = [1 -0.9512];            %Denominator PT1 Antriebsstrang

par_VEH.vmax = 140; %Max speed in km/h

% % Gearbox
%         par_VEH.gear_ratio_1M = 9.73;              % [-] 1 axle motor
%         par_VEH.gear_ratio_2M = 9.73;              % [-] 2 axle motors
%         par_VEH.differential_ratio = 1;         % [-]
%         par_VEH.eta_gear_1M = 0.97;                % [-]
%         par_VEH.eta_gear_2M = 0.97;               % [-]
%         
par_VEH.M_max_Brake_at_Tire = -10500;


%% Calculations
% Werden nicht mehr benötigt
%par_VEH.sF05=par_VEH.sF/2;
%par_VEH.sR05=par_VEH.sR/2;
%par_VEH.z_preload_F=-par_VEH.m*par_VEH.g*par_VEH.lR/par_VEH.l/par_VEH.csF/2;
%par_VEH.z_preload_R=-par_VEH.m*par_VEH.g*par_VEH.lF/par_VEH.l/par_VEH.csR/2;

par_VEH.zRC = (par_VEH.zRCf-par_VEH.zRCr)/par_VEH.l*par_VEH.lR+par_VEH.zRCr;
par_VEH.zsSP = ((par_VEH.m*par_VEH.zSP)-(par_VEH.m_usF*par_VEH.ztSPf)-(par_VEH.m_usR*par_VEH.ztSPr))/par_VEH.mss;  %Schwerpunktslage der gefederten Massen in z-Richtung [m]
if par_VEH.lR*par_VEH.FWD > par_VEH.lF*par_VEH.RWD
    par_VEH.alvkrit = par_VEH.lR/par_VEH.l;
else
    par_VEH.alvkrit = par_VEH.lF/par_VEH.l;
end

par_VEH.trac_lim = par_VEH.m*par_VEH.g/2*par_VEH.r_stat0*par_VEH.alvkrit;
%Initial
% v0=0;

constant_springrate

%% Torque Vectoring Regelung parametrieren
[par_VEH] = torque_vectoring_control(par_VEH,par_TIR);

end